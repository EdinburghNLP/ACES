<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>File System Examples</title>
    <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
    <py-env>
        - paths:
          - ./main.py
          - ./annotations/subset.json
    </py-env>
  </head>
  <body>
    <py-title>Compare Annotations</py-title>
    <label for="myfile">Select a file:</label>
    <input type="file" id="myfile" name="myfile">
    <br />
    <div id="print_output"></div>
    <br />
    <py-script output="print_output">
        import asyncio
        from js import document, FileReader
        from pyodide import create_proxy
        from main import Annotations
        import js
        def handler(loop, context):
            js.console.error(context.message)
            raise(context.exception)
        pyscript.loop.set_exception_handler(handler)
        annotations_obj = Annotations("./subset.json")

        def vis_item(res):
            document.getElementById("debug").innerHTML += "here!!\n"
            document.getElementById("out_raw").innerHTML = res[0]
            for i in range(1, len(res)):
                if res[i] != "-":
                    ref, good, bad, spans = res[i]
                    text = "\nReference: {}\nGood translation: {}\nIncorrect translation: {}".format(ref, good, bad)
                else:
                    text = res[i]
                document.getElementById("out"+str(i)).innerHTML = text
            document.getElementById("debug").innerHTML += "vis_item successfull!!\n"

        async def process_file(event):
            fileList = event.target.files.to_py()
            for f in fileList:
                data = await f.text()
                try:
                    annotations_obj.add(data)
                    if annotations_obj.i >= 0:
                        res = annotations_obj.get_item()
                    else:
                        res = annotations_obj.next()
                except:
                    document.getElementById("debug").innerHTML += "error!!!\n"
                if res == -1:
                    document.getElementById("debug").innerHTML += "DONE!!"
                vis_item(res)

        def next():
            print("hereeee")
        
        
        def main():
            # Create a Python proxy for the callback function
            # process_file() is your function to process events from FileReader
            file_event = create_proxy(process_file)

            # Set the listener to the callback
            e = document.getElementById("myfile")
            e.addEventListener("change", file_event, False)

        main()
</py-script>

<div id="raw">
    <p>Sample</p>
    <div style="border:5px inset #c7299a;cursor:text;height:200px;overflow:auto;resize:both">
        <div id="out_raw">
    </div>
</div>

<py-box widths="1/2;1/2">
    <div>
        <p>Annotation 1</p>
        <div style="border:5px inset #f9b4cf;cursor:text;height:200px;overflow:auto;resize:both">
        <div id="out1">
        </div>
        </div>
    </div>
    <div>
        <p>Annotation 2</p>
        <div style="border:5px inset #bad8a6;cursor:text;height:200px;overflow:auto;resize:both">
        <div id="out2">
        </div>
        </div>
    </div>
</py-box>
<py-box widths="1/2;1/2">
    <div>
        <p>Annotation 3</p>
        <div style="border:5px inset #ecdeb5;cursor:text;height:200px;overflow:auto;resize:both">
        <div id="out3">
        </div>
        </div>
    </div>
    <div>
        <p>Annotation 4</p>
        <div style="border:5px inset #72bfef;cursor:text;height:200px;overflow:auto; resize:both">
        <div id="out4">
        </div>
        </div>
    </div>
</py-box>

<button id = "next" class = "btn btn-primary" type = "submit" pys-onClick="next_tmp">Next</button>

<py-script>          
    def next_tmp(*args, **kwargs):
        print("hereee")
</py-script>

<py-box widths="1/2;1/2">
    <div>
        <button type="button" id="next">Next</button>
    </div>
    <div>
        <py-button label="Back" styles="btn big">
            def on_click(event):
                print(event)
        </py-button>
    </div>
</py-box>


<p>Debugger:</p>
    <div style="border:2px inset #AAA;cursor:text;height:120px;overflow:auto;width:600px; resize:both">
      <div id="debug">
      </div>
    </div>
</body>
</html>